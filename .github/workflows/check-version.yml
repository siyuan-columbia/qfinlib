name: Check Version

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for version comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Extract version from pyproject.toml
        id: pyproject_version
        run: |
          VERSION=$(grep -E '^\s*version\s*=' pyproject.toml | sed -E 's/^\s*version\s*=\s*"([^"]+)"/\1/' | tr -d ' ')
          if [ -z "$VERSION" ]; then
            echo "❌ Could not extract version from pyproject.toml"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version in pyproject.toml: $VERSION"

      - name: Extract version from __init__.py
        id: init_version
        run: |
          VERSION=$(grep -E '__version__\s*=' qfinlib/__init__.py | sed -E "s/__version__\s*=\s*['\"]([^'\"]+)['\"]/\1/" | tr -d ' ')
          if [ -z "$VERSION" ]; then
            echo "❌ Could not extract version from qfinlib/__init__.py"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version in __init__.py: $VERSION"

      - name: Check version consistency
        run: |
          PYPROJECT_VERSION="${{ steps.pyproject_version.outputs.version }}"
          INIT_VERSION="${{ steps.init_version.outputs.version }}"
          
          if [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ]; then
            echo "❌ Version mismatch detected!"
            echo "  pyproject.toml: $PYPROJECT_VERSION"
            echo "  __init__.py: $INIT_VERSION"
            echo "Versions must match in both files."
            exit 1
          fi
          
          echo "✅ Versions are consistent: $PYPROJECT_VERSION"

      - name: Get base branch version (for PRs)
        if: github.event_name == 'pull_request'
        id: base_version
        run: |
          git fetch origin ${{ github.base_ref }}:base-branch 2>/dev/null || true
          BASE_VERSION=$(git show base-branch:pyproject.toml 2>/dev/null | grep -E '^\s*version\s*=' | sed -E 's/^\s*version\s*=\s*"([^"]+)"/\1/' | tr -d ' ' || echo "0.0.0")
          echo "version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Base branch version: $BASE_VERSION"

      - name: Install packaging library
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install packaging

      - name: Check if version was updated (for PRs)
        if: github.event_name == 'pull_request'
        run: |
          CURRENT_VERSION="${{ steps.pyproject_version.outputs.version }}"
          BASE_VERSION="${{ steps.base_version.outputs.version }}"
          
          echo "Base version: $BASE_VERSION"
          echo "Current version: $CURRENT_VERSION"
          
          # Compare versions using Python
          python3 << 'EOF'
          from packaging import version
          import os
          
          base = os.environ.get('BASE_VERSION', '0.0.0')
          current = os.environ.get('CURRENT_VERSION', '0.0.0')
          
          if base == "0.0.0":
              print("⚠️  Base version not found, skipping version update check")
              exit(0)
          
          try:
              if version.parse(current) <= version.parse(base):
                  print(f"❌ Version not updated!")
                  print(f"  Base version: {base}")
                  print(f"  Current version: {current}")
                  print(f"  Version must be greater than base version.")
                  exit(1)
              else:
                  print(f"✅ Version updated correctly")
                  print(f"  Base version: {base}")
                  print(f"  Current version: {current}")
                  exit(0)
          except Exception as e:
              print(f"⚠️  Error comparing versions: {e}")
              print("Skipping version update check")
              exit(0)
          EOF
        env:
          BASE_VERSION: ${{ steps.base_version.outputs.version }}
          CURRENT_VERSION: ${{ steps.pyproject_version.outputs.version }}

      - name: Check version format
        run: |
          VERSION="${{ steps.pyproject_version.outputs.version }}"
          
          # Check if version follows semantic versioning (X.Y.Z)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "❌ Invalid version format: $VERSION"
            echo "Version must follow semantic versioning (X.Y.Z)"
            exit 1
          fi
          
          echo "✅ Version format is valid: $VERSION"
